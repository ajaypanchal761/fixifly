<!DOCTYPE html>
<html>
<head>
    <title>OneSignal State Debug</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
    <h1>OneSignal State Debug & Clear</h1>
    <div id="output"></div>
    <button onclick="clearOneSignalState()">Clear OneSignal State</button>

    <script>
        function log(message) {
            document.getElementById('output').innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        async function debugOneSignalState() {
            log('üîç Checking OneSignal state...');
            
            // Wait for OneSignal to load
            if (typeof window.OneSignal === 'undefined') {
                log('‚è≥ Waiting for OneSignal SDK to load...');
                await new Promise((resolve) => {
                    const checkOneSignal = () => {
                        if (typeof window.OneSignal !== 'undefined') {
                            resolve();
                        } else {
                            setTimeout(checkOneSignal, 100);
                        }
                    };
                    checkOneSignal();
                });
            }

            log('‚úÖ OneSignal SDK loaded');

            // Check initialization status
            log('üîß OneSignal initialization status: ' + (window.OneSignalInitialized ? 'Initialized' : 'Not initialized'));

            // Check if OneSignal has cached operations or state
            if (window.OneSignal.User) {
                log('üë§ OneSignal.User available: ' + Object.keys(window.OneSignal.User).join(', '));
                try {
                    const playerId = await window.OneSignal.User.getPlayerId();
                    log('üì± Player ID: ' + playerId);
                } catch (e) {
                    log('üì± Player ID error: ' + e.message);
                }
            }

            // Check external user ID
            try {
                const externalUserId = await window.OneSignal.User.getExternalUserId();
                log('üÜî External User ID: ' + externalUserId);
            } catch (e) {
                log('üÜî External User ID error: ' + e.message);
            }

            // Check if there are any pending operations
            log('üîÑ OneSignal internal state check...');
            if (window.OneSignal._internal) {
                log('üìä Internal state: ' + Object.keys(window.OneSignal._internal).join(', '));
            }

            log('‚úÖ OneSignal state check complete');
        }

        async function clearOneSignalState() {
            log('üßπ Clearing OneSignal state...');
            
            try {
                // Remove external user ID
                await window.OneSignal.User.removeExternalUserId();
                log('‚úÖ External user ID removed');

                // Clear any persistent storage
                if (typeof localStorage !== 'undefined') {
                    localStorage.removeItem('OneSignal-sdk');
                    localStorage.removeItem('OneSignal-setup');
                    log('‚úÖ Local storage cleared');
                }

                // Clear session storage
                if (typeof sessionStorage !== 'undefined') {
                    sessionStorage.clear();
                    log('‚úÖ Session storage cleared');
                }

                log('‚úÖ OneSignal state cleared successfully');
                log('üí° Please refresh the page to restart OneSignal');
                
            } catch (error) {
                log('‚ùå Error clearing OneSignal state: ' + error.message);
            }
        }

        // Run debug on page load
        window.addEventListener('load', debugOneSignalState);
    </script>
</body>
</html>
